#!/usr/bin/env php
<?php

if (strpos(__DIR__, 'vendor') === false) {
    require __DIR__ . '/vendor/autoload.php';
    $scanDir = __DIR__.'/../';
} else {
    require __DIR__ . '/../../../autoload.php';
    $scanDir = __DIR__.'/../../../../';
}

$fs = new Symfony\Component\Filesystem\Filesystem();
$finder = new \Symfony\Component\Finder\Finder();
$finder
    ->files()
    ->in($scanDir)
    ->path('/\/analytics\//i')
    ->name('*.js')
    ->notName('_*')
    ->sortByName();

foreach ($finder as $file) {
    $fullPath = $file->getPathname();
    $json = parseFile($fullPath);

    // multipipe file?
    if (substr_count($file->getFilename(), '.') > 1) {
        $targetFileName = substr($file->getFilename(), 0, strpos($file->getFilename(), '.'));
        $subName = substr($file->getFilename(), strpos($file->getFilename(), '.'), -3);
        $targetFileName = $file->getPath().'/'.$targetFileName.'.pipeline'.$subName.'.json';
    } else {
        $targetFileName = substr($fullPath, 0, -2).'pipeline.json';
    }

    $fs->dumpFile($targetFileName, json_encode($json, JSON_PRETTY_PRINT));
    echo "wrote ".$targetFileName.PHP_EOL;
}

function parseFile($jsFilePath)
{
    $content = file_get_contents($jsFilePath);

    // fixed "new Date" instances
    $content = preg_replace('/new Date\(\)/i', '"#newDate#"', $content);

    // params are marked by comments like:
    /* param:theName */ $i = 2; /* endparam */
    $content = preg_replace('@\/\* param\:([a-z0-9]*) \*\/(.*)\/\* endparam \*\/@i', '"\${$1}"', $content);

    // remove other comments
    $content = preg_replace('@\/\*(.*)\*\/@im', '', $content);

    $jsonParser = new \Seld\JsonLint\JsonParser();
    $structure = $jsonParser->parse($content);

    return $structure;
}
